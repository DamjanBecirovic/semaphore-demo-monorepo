version: v1.0
name: 'Stage ${{parameters.ENVIRONMENT}}'
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
queue:
  name: '${{parameters.ENVIRONMENT}}-queue'
  scope: project
blocks:
  - name: Deploy
    task:
      jobs:
        - name: Stage
          commands:
            - 'heroku apps:create "monorepo-${ENVIRONMENT}-staging"'
            - checkout
            - cd services/$ENVIRONMENT
            - git init
            - git config user.email "$HEROKU_EMAIL"
            - git config user.name "$HEROKU_EMAIL"
            - 'git config credential.helper ''!f() { printf "%s\n" "username=''$HEROKU_EMAIL''" "password=''$HEROKU_API_KEY''"; };f'''
            - 'heroku git:remote -a "monorepo-${ENVIRONMENT}-staging"'
            - git add .
            - git commit -m "deploy monorepo-${ENVIRONMENT}-staging to Heroku"
            - git push heroku master --force
      secrets:
        - name: heroku-tomfern
